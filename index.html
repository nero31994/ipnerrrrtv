<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClearKey DRM with DASH</title>
</head>
<body>
    <h1>Video Player with ClearKey DRM</h1>

    <!-- Video Element -->
    <video id="video" width="640" height="360" controls></video>

    <script>
        // Replace these with your actual MPD URL and ClearKey details
        const mpdUrl = 'https://qp-pldt-live-grp-03-prod.akamaized.net/out/u/cnn_rptv_prod_hd.mpd'; // Replace with your DASH MPD URL
        const keyId = 'GRf0yvI2Tm2bFQcyaoXq1g=='; // Replace with your ClearKey Key ID (Base64-encoded)
        const key = 'oTQKJRpapjqbDqXZ1/Z1lQ=='; // Replace with your ClearKey Key (Base64-encoded)

        // Function to initialize the video with ClearKey
        async function initializePlayer() {
            const video = document.getElementById('video');

            // Step 1: Fetch the MPD file
            const response = await fetch(mpdUrl);
            if (!response.ok) {
                console.error('Failed to fetch MPD file');
                return;
            }

            const mpdData = await response.text();

            // Step 2: Parse the MPD and get media segments
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(mpdData, 'application/xml');

            // Assuming a simple DASH structure for demonstration purposes
            const initSegmentUrl = xmlDoc.querySelector('Initialization').getAttribute('sourceURL');
            const mediaSegmentUrl = xmlDoc.querySelector('SegmentURL').getAttribute('media');

            const mediaSource = new MediaSource();
            video.src = URL.createObjectURL(mediaSource);

            mediaSource.addEventListener('sourceopen', async () => {
                const sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.64001e, mp4a.40.2"');

                // Fetch and append initialization segment
                const initSegment = await fetch(initSegmentUrl).then(res => res.arrayBuffer());
                sourceBuffer.appendBuffer(initSegment);

                // Fetch and append media segment
                const mediaSegment = await fetch(mediaSegmentUrl).then(res => res.arrayBuffer());
                sourceBuffer.appendBuffer(mediaSegment);

                mediaSource.endOfStream();
            });

            // Step 3: Configure ClearKey DRM
            const keySystem = 'org.w3.clearkey';
            const keySystemConfig = {
                initDataTypes: ['cenc'],
                videoCapabilities: [{ contentType: 'video/mp4; codecs="avc1.64001e"' }]
            };

            const mediaKeys = await navigator.requestMediaKeySystemAccess(keySystem, [keySystemConfig])
                .then(access => access.createMediaKeys());

            await video.setMediaKeys(mediaKeys);

            const session = mediaKeys.createSession();
            session.addEventListener('message', event => {
                const keyObject = {
                    keys: [{
                        kty: 'oct',
                        kid: keyId,
                        k: key
                    }]
                };

                session.update(new TextEncoder().encode(JSON.stringify(keyObject)));
            });

            // Trigger an encrypted event
            video.addEventListener('encrypted', event => {
                session.generateRequest(event.initDataType, event.initData);
            });
        }

        initializePlayer().catch(err => {
            console.error('Error initializing player:', err);
        });
    </script>
</body>
</html>
